<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•è°ƒè¯•å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #409EFF;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        button {
            width: 100%;
            padding: 15px;
            background: #409EFF;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        button:hover {
            background: #66b1ff;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log-box {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .log-item {
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }
        .log-item:last-child {
            border-bottom: none;
        }
        .success { color: #67C23A; font-weight: bold; }
        .error { color: #F56C6C; font-weight: bold; }
        .info { color: #409EFF; }
        .warning { color: #E6A23C; }
        .step { color: #303133; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” XU-News-AI-RAG ç™»å½•è°ƒè¯•å·¥å…·</h1>
        <p class="subtitle">ç‚¹å‡»æŒ‰é’®è‡ªåŠ¨æ‰§è¡Œå®Œæ•´çš„ç™»å½•æµ‹è¯•æµç¨‹</p>
        
        <button id="startBtn" onclick="startDebug()">å¼€å§‹è°ƒè¯•ç™»å½•</button>
        
        <div class="log-box" id="logBox">
            <div class="info">å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹è°ƒè¯•...</div>
        </div>
    </div>

    <script>
        let logCount = 0;

        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            if (logCount === 0) {
                logBox.innerHTML = '';
            }
            logCount++;
            
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `log-item ${type}`;
            div.textContent = `[${time}] ${message}`;
            logBox.appendChild(div);
            logBox.scrollTop = logBox.scrollHeight;
        }

        function startDebug() {
            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            btn.textContent = 'è°ƒè¯•è¿›è¡Œä¸­...';
            logCount = 0;

            log('========================================', 'step');
            log('å¼€å§‹ç™»å½•è°ƒè¯•æµç¨‹', 'step');
            log('========================================', 'step');
            log('');

            // æ­¥éª¤1: æ¸…é™¤ç¼“å­˜
            log('æ­¥éª¤ 1/8: æ¸…é™¤localStorage', 'step');
            localStorage.clear();
            sessionStorage.clear();
            log('âœ… localStorageå·²æ¸…é™¤', 'success');
            log('');

            // æ­¥éª¤2: è°ƒç”¨ç™»å½•API
            log('æ­¥éª¤ 2/8: è°ƒç”¨ç™»å½•API...', 'step');
            log('   URL: http://localhost:5000/api/auth/login', 'info');
            log('   ç”¨æˆ·å: admin', 'info');
            
            fetch('http://localhost:5000/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: 'admin', password: 'admin123'})
            })
            .then(res => {
                log('');
                log('æ­¥éª¤ 3/8: æ”¶åˆ°ç™»å½•å“åº”', 'step');
                log('   HTTPçŠ¶æ€: ' + res.status, res.status === 200 ? 'success' : 'error');
                return res.json();
            })
            .then(data => {
                log('   å“åº”æ¶ˆæ¯: ' + data.message, 'info');
                
                if (!data.access_token) {
                    log('âŒ è‡´å‘½é”™è¯¯: æ²¡æœ‰æ”¶åˆ°access_token!', 'error');
                    btn.disabled = false;
                    btn.textContent = 'é‡æ–°å¼€å§‹';
                    return;
                }
                
                log('âœ… æ”¶åˆ°access_token', 'success');
                log('');
                
                // æ­¥éª¤3: ä¿å­˜Token
                const token = data.access_token;
                log('æ­¥éª¤ 4/8: ä¿å­˜Tokenåˆ°localStorage', 'step');
                log('   Tokené•¿åº¦: ' + token.length + ' å­—ç¬¦', 'info');
                log('   Tokenå‰ç¼€: ' + token.substring(0, 30) + '...', 'info');
                
                localStorage.setItem('access_token', token);
                localStorage.setItem('user_info', JSON.stringify(data.user));
                log('âœ… Tokenå·²ä¿å­˜', 'success');
                log('');
                
                // æ­¥éª¤4: éªŒè¯ä¿å­˜
                log('æ­¥éª¤ 5/8: éªŒè¯localStorageä¿å­˜', 'step');
                const savedToken = localStorage.getItem('access_token');
                const savedUser = localStorage.getItem('user_info');
                
                if (savedToken === token) {
                    log('âœ… Tokenè¯»å–éªŒè¯é€šè¿‡', 'success');
                } else {
                    log('âŒ Tokenè¯»å–éªŒè¯å¤±è´¥!', 'error');
                    btn.disabled = false;
                    btn.textContent = 'é‡æ–°å¼€å§‹';
                    return;
                }
                log('   ä¿å­˜çš„ç”¨æˆ·: ' + JSON.parse(savedUser).username, 'info');
                log('');
                
                // æ­¥éª¤5: æµ‹è¯•Tokenæœ‰æ•ˆæ€§
                log('æ­¥éª¤ 6/8: æµ‹è¯•Tokenæœ‰æ•ˆæ€§ (/api/auth/me)', 'step');
                fetch('http://localhost:5000/api/auth/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                })
                .then(res => {
                    log('   å“åº”çŠ¶æ€: ' + res.status, res.status === 200 ? 'success' : 'error');
                    if (res.status !== 200) {
                        log('âŒ Tokenåœ¨åç«¯éªŒè¯å¤±è´¥!', 'error');
                        btn.disabled = false;
                        btn.textContent = 'é‡æ–°å¼€å§‹';
                        return Promise.reject('TokenéªŒè¯å¤±è´¥');
                    }
                    return res.json();
                })
                .then(userData => {
                    log('âœ… Tokenæœ‰æ•ˆï¼Œç”¨æˆ·: ' + userData.user.username, 'success');
                    log('');
                    
                    // æ­¥éª¤6: æµ‹è¯•æ–‡æ¡£API
                    log('æ­¥éª¤ 7/8: æµ‹è¯•æ–‡æ¡£åˆ—è¡¨API', 'step');
                    fetch('http://localhost:5000/api/documents/?page=1&per_page=20', {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        }
                    })
                    .then(res => {
                        log('   å“åº”çŠ¶æ€: ' + res.status, res.status === 200 ? 'success' : 'error');
                        if (res.status !== 200) {
                            log('âŒ æ–‡æ¡£APIè°ƒç”¨å¤±è´¥!', 'error');
                            btn.disabled = false;
                            btn.textContent = 'é‡æ–°å¼€å§‹';
                            return Promise.reject('æ–‡æ¡£APIå¤±è´¥');
                        }
                        return res.json();
                    })
                    .then(docsData => {
                        log('âœ… æ–‡æ¡£APIæ­£å¸¸ï¼Œæ€»æ•°: ' + docsData.total, 'success');
                        log('');
                        
                        // æ­¥éª¤7: æœ€ç»ˆéªŒè¯
                        log('æ­¥éª¤ 8/8: æœ€ç»ˆéªŒè¯', 'step');
                        log('   Token: ' + (localStorage.getItem('access_token') ? 'âœ… å­˜åœ¨' : 'âŒ ä¸¢å¤±'), 'info');
                        log('   ç”¨æˆ·ä¿¡æ¯: ' + (localStorage.getItem('user_info') ? 'âœ… å­˜åœ¨' : 'âŒ ä¸¢å¤±'), 'info');
                        log('');
                        
                        log('========================================', 'step');
                        log('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å‡†å¤‡è·³è½¬...', 'success');
                        log('========================================', 'step');
                        log('');
                        log('â° 5ç§’å€’è®¡æ—¶åè·³è½¬åˆ°æ–‡æ¡£é¡µé¢...', 'warning');
                        log('   å¦‚æœè·³è½¬åè¿˜æ˜¯é—ªé€€ï¼Œè¯´æ˜æ˜¯Vueç»„ä»¶çš„é—®é¢˜', 'warning');
                        log('');
                        
                        let countdown = 5;
                        const timer = setInterval(() => {
                            countdown--;
                            if (countdown > 0) {
                                log('   ' + countdown + 'ç§’...', 'info');
                            } else {
                                clearInterval(timer);
                                log('ğŸš€ æ­£åœ¨è·³è½¬...', 'info');
                                
                                // å†æ¬¡ç¡®è®¤tokenå­˜åœ¨
                                const finalToken = localStorage.getItem('access_token');
                                if (finalToken) {
                                    log('âœ… è·³è½¬å‰Tokenä»ç„¶å­˜åœ¨', 'success');
                                    window.location.href = '/documents';
                                } else {
                                    log('âŒ è·³è½¬å‰Tokenä¸¢å¤±äº†!!!', 'error');
                                }
                            }
                        }, 1000);
                        
                        btn.textContent = 'æµ‹è¯•å®Œæˆï¼Œå³å°†è·³è½¬...';
                    })
                    .catch(err => {
                        log('âŒ æ–‡æ¡£APIé”™è¯¯: ' + err, 'error');
                        btn.disabled = false;
                        btn.textContent = 'é‡æ–°å¼€å§‹';
                    });
                })
                .catch(err => {
                    log('âŒ TokenéªŒè¯é”™è¯¯: ' + err, 'error');
                    btn.disabled = false;
                    btn.textContent = 'é‡æ–°å¼€å§‹';
                });
            })
            .catch(err => {
                log('âŒ ç™»å½•APIé”™è¯¯: ' + err, 'error');
                btn.disabled = false;
                btn.textContent = 'é‡æ–°å¼€å§‹';
            });
        }
    </script>
</body>
</html>


